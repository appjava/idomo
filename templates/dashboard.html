<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart EchoHome Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --purple-dark: #6b48ff;
            --blue-light: #00ddeb;
            --orange-accent: #ff8c42;
            --green-on: #a9dfbf;
            --green-on-darker: #82c99d;
            --grey-off: #d3d3d3;
            --grey-off-darker: #b0b0b0;
            --white: #ffffff;
            --purple-gradient-start: #e6e6fa;
            --text-dark: #333;
            --text-light: #f8f9fa;
            --sans-serif-font: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            /* Specific light mode colors that need dark mode counterparts */
            --card-bg-light: #ffffff;
            --control-bg-light: #fdfdfd;
            --control-border-light: #e9ecef;
            --subtle-text-light: #555;
            --shadow-color-light: rgba(0,0,0,0.07);
            --shadow-color-light-hover: rgba(0,0,0,0.1);
            --automation-form-bg-light: #f8f9fa;
            --input-border-light: #ced4da;
            --footer-text-light: #7f8c8d;
        }

        /* DARK MODE START Variable Definitions */
        body.dark-mode {
            --purple-dark: #7a5afc; /* Slightly lighter for dark bg */
            --blue-light: #00c4d4;
            --orange-accent: #ffa057;
            --green-on: #8dc9a0;
            --green-on-darker: #6fab82;
            --grey-off: #4a4a4a;
            --grey-off-darker: #5c5c5c;
            --white: #1e1e2f; /* Dark background */
            --purple-gradient-start: #2c2c54; /* Darker gradient start */
            --text-dark: #e0e0e0; /* Light text for dark mode */
            --text-light: #121212; /* Dark text if needed on light elements in dark mode */
            --card-bg-light: #2a2a3f;
            --control-bg-light: #333348;
            --control-border-light: #4f4f6a;
            --subtle-text-light: #bbbbcc;
            --shadow-color-light: rgba(255,255,255,0.05);
            --shadow-color-light-hover: rgba(255,255,255,0.08);
            --automation-form-bg-light: #252538;
            --input-border-light: #5f5f7a;
            --footer-text-light: #8a8a9f;
        }
        /* DARK MODE END Variable Definitions */

        body {
            font-family: var(--sans-serif-font);
            margin: 0;
            background: linear-gradient(to bottom, var(--purple-gradient-start), var(--white));
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
            font-size: 16px; /* Base font size */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
        }

        .sidebar {
            width: 80px;
            background-color: var(--purple-dark);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .sidebar .nav-icon {
            color: var(--white); /* This white is a specific color, not the general background */
            font-size: 1.8em;
            margin-bottom: 30px;
            cursor: pointer;
        }
        body.dark-mode .sidebar .nav-icon { /* Ensure sidebar icons remain light */
            color: #f0f0f0;
        }

        .main-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .top-header {
            padding: 20px 30px;
            /* background-color: var(--white); */
            /* box-shadow: 0 2px 10px rgba(0,0,0,0.05); */
            display: flex;
            justify-content: right;
            align-items: center;
        }

        .top-header h1 {
            color: var(--purple-dark);
            font-weight: 600;
            font-size: 2em;
            margin: 0;
        }

        .top-header .header-icons i,
        .top-header .header-icons button /* DARK MODE Button styling */
        {
            font-size: 1.5em;
            color: var(--purple-dark);
            margin-left: 20px;
            cursor: pointer;
        }

        /* DARK MODE START Toggle Button */
        .top-header .header-icons button#darkModeToggle {
            background: none;
            border: none;
            padding: 0;
            color: var(--purple-dark); /* Inherits icon color */
            line-height: 1; /* Align icon properly */
        }
        /* .top-header .header-icons button#darkModeToggle .fa-sun { */
            /* Style for sun icon if needed, e.g., slightly different color */
        /* } */
        /* DARK MODE END Toggle Button */

        .dashboard-content {
            padding: 0px 30px 30px 30px;
            flex-grow: 1;
        }

        .welcome-panel {
            background-color: var(--card-bg-light); /* Use variable */
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px var(--shadow-color-light); /* Use variable */
        }
        body.dark-mode .welcome-panel {
            background-color: rgba(42, 42, 63, 0.8); /* Slightly transparent dark */
        }

        .welcome-panel h2 {
            margin: 0 0 10px 0;
            color: var(--purple-dark);
            font-size: 1.8em;
            font-weight: 600;
        }

        .welcome-panel p {
            margin: 0 0 15px 0;
            font-size: 1em;
            color: var(--subtle-text-light); /* Use variable */
        }

        .weather-info {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: var(--purple-dark);
        }

        .weather-info span {
            background-color: var(--purple-gradient-start);
            padding: 8px 12px;
            border-radius: 8px;
        }

        

        .main-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        h2.section-title {
            color: var(--purple-dark);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 500;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--purple-gradient-start);
        }

        /* Sensor Widgets */
        .sensor-widgets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .widget {
            background-color: var(--card-bg-light); /* Use variable */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 6px 20px var(--shadow-color-light); /* Use variable */
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow-color-light-hover); /* Use variable */
        }

        .widget-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: var(--blue-light); /* Default icon color */
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, var(--blue-light), var(--purple-dark));
            color: var(--white); /* This white is specific for icon text on gradient */
            margin-left: auto;
            margin-right: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        body.dark-mode .widget-icon { /* Ensure icon text is light */
            color: #f0f0f0;
        }

        .widget-icon.temp { background: linear-gradient(145deg, #ff8c42, #ffc107); }
        .widget-icon.humidity { background: linear-gradient(145deg, #17a2b8, #00ddeb); }
        .widget-icon.voltage { background: linear-gradient(145deg, #6f42c1, #6b48ff); }
        .widget-icon.capacity { background: linear-gradient(145deg, #28a745, #a9dfbf); }
        .widget-icon.power { background: linear-gradient(145deg, #fd4614, #ff6b42); }
        .widget-icon.generate { background: linear-gradient(145deg, #fd7e14, #ff8c42); }
        .widget-icon.energy { background: linear-gradient(145deg, #ffc107, #ffe082); }
        .widget-icon.source { background: linear-gradient(145deg, #6c757d, #adb5bd); }
        .widget-icon.hours { background: linear-gradient(145deg, #343a40, #6c757d); }

        .widget-label {
            font-size: 1em;
            color: var(--subtle-text-light); /* Use variable */
            margin-bottom: 8px;
            font-weight: 500;
        }

        .widget-value {
            font-size: 1.8em; /* Increased from 1.2em for better visibility */
            font-weight: 600;
            color: var(--purple-dark);
        }

        

        /* Charge Banner */
        .charge-banner {
            color: var(--text-dark); /* Text color will depend on banner bg */
            padding: 15px 20px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
            background-color: var(--grey-off); /* Default grey */
        }
        body.dark-mode .charge-banner { /* Ensure text is readable on dark grey */
            color: #e0e0e0;
        }
        .charge-banner.charge-high { background-color: var(--green-on); color: var(--text-dark); }
        .charge-banner.charge-medium { background-color: var(--orange-accent); color: var(--white); } /* White specific for orange */
        .charge-banner.charge-low { background-color: #dc3545; color: var(--white); } /* White specific for red */
        .charge-banner.charge-charging { background-color: var(--blue-light); color: var(--text-dark); }
        .charge-banner.status-error { background-color: #721c24; color: #f8d7da; } /* Ensure this class is distinct from .status.error */


        body.dark-mode .charge-banner.charge-high { color: #121212; } /* Dark text on light green */
        body.dark-mode .charge-banner.charge-medium { color: #121212; } /* Dark text on orange */
        body.dark-mode .charge-banner.charge-charging { color: #121212; } /* Dark text on light blue */

        /* Device Controls */
        .device-group {
            background-color: var(--card-bg-light); /* Use variable */
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 20px var(--shadow-color-light); /* Use variable */
            margin-bottom: 20px;
        }

        .device-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            margin-bottom: 12px;
            background-color: var(--control-bg-light); /* Use variable */
            border: 1px solid var(--control-border-light); /* Use variable */
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .device-control:hover {
            background-color: var(--purple-gradient-start); /* Use a variable that changes with theme */
        }
        body.dark-mode .device-control:hover {
            background-color: #383858; /* Darker hover for dark mode controls */
        }

        .device-info {
            display: flex;
            align-items: center;
        }

        .device-icon {
            font-size: 1.8em;
            color: var(--white); /* Specific white for icon text */
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        body.dark-mode .device-icon { /* Ensure icon text is light */
            color: #f0f0f0;
        }

        .device-icon.light { background: linear-gradient(145deg, #ffc107, #ffeb3b); }
        .device-icon.power-outlet { background: linear-gradient(145deg, #00ddeb, #84ffff); }

        .device-label {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--purple-dark);
        }

        .status-container {
            font-size: 0.8em;
            color: #6c757d; /* This color is fine for both modes or use a variable */
        }
        body.dark-mode .status-container {
            color: #9a9aab;
        }
        .status-container .status { margin-top: 3px; }
        .status-container .auto-status { font-style: italic; }

        .status.success { color: var(--green-on-darker); font-weight: 500; }
        .status.error { color: #dc3545; font-weight: 500; }
        .status.info { color: var(--blue-light); font-weight: 500; }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px; /* Increased width */
            height: 30px; /* Increased height */
        }

        .switch input { display: none; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--grey-off);
            transition: .3s;
            border-radius: 30px; /* Adjusted for height */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px; /* Adjusted size */
            width: 24px; /* Adjusted size */
            left: 3px; /* Adjusted position */
            bottom: 3px; /* Adjusted position */
            background-color: white; /* Slider knob always white for contrast */
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        body.dark-mode .slider:before {
            background-color: #e0e0e0; /* Slightly off-white for dark mode knob */
        }

        input:checked + .slider {
            background: linear-gradient(to right, var(--grey-off-darker), var(--green-on));
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--green-on-darker);
        }

        input:checked + .slider:before {
            transform: translateX(30px); /* Adjusted for new width */
        }

        /* Energy Buttons (for CH5-CH6 if not using toggles) */
        .energy-buttons button {
            color: white; /* Specific white */
            border: none;
            padding: 10px 15px;
            font-size: 0.95em;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin: 0 5px;
            min-width: 60px;
        }
        body.dark-mode .energy-buttons button.on-button {
            color: #121212; /* Dark text on light green */
        }
        body.dark-mode .energy-buttons button.off-button {
            color: #e0e0e0; /* Light text on dark grey */
        }

        .energy-buttons button.on-button { background-color: var(--green-on); color: var(--text-dark); }
        .energy-buttons button.off-button { background-color: var(--grey-off); color: var(--text-dark); }
        .energy-buttons button:hover { filter: brightness(110%); }
        .energy-buttons button:active { transform: scale(0.97); }

        /* Automation Section */
        .automation-form {
            margin-top: 0; /* Removed top margin as it's inside a device-group like card */
            padding: 20px;
            background-color: var(--automation-form-bg-light); /* Use variable */
            border-radius: 8px;
            border: 1px solid var(--control-border-light); /* Use variable */
        }

        .automation-form div {
            margin-bottom:15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .automation-form label {
            font-weight: 500;
            color: var(--purple-dark);
            min-width: 50px; /* Align labels */
        }

        .automation-form input[type="time"],
        .automation-form select {
            padding: 10px;
            border: 1px solid var(--input-border-light); /* Use variable */
            border-radius: 6px;
            font-size: 0.95em;
            flex-grow:1;
            background-color: var(--card-bg-light); /* Use variable for input background */
            color: var(--text-dark); /* Ensure input text is readable */
        }
        body.dark-mode .automation-form input[type="time"],
        body.dark-mode .automation-form select {
            background-color: var(--control-bg-light); /* Slightly different from card bg for inputs */
            color: var(--text-dark); /* Ensure text is light on dark inputs */
        }


        .automation-form button {
            padding: 10px 18px;
            background-color: var(--blue-light);
            color: var(--text-dark);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease;
            margin-right:10px;
        }
        body.dark-mode .automation-form button {
            color: #121212; /* Dark text for buttons on light-ish backgrounds */
        }
        body.dark-mode .automation-form button.clear-button {
            color: #e0e0e0; /* Light text for clear button on dark grey */
        }

        .automation-form button:hover { background-color: #00b8d4; }
        .automation-form button:active { transform: scale(0.97); }
        .automation-form button.clear-button {
            background-color: var(--grey-off);
        }
        .automation-form button.clear-button:hover {
            background-color: var(--grey-off-darker);
        }

        .automation-list { margin-top: 20px; }
        .automation-rule {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background-color: var(--control-bg-light); /* Use variable */
            border: 1px solid var(--control-border-light); /* Use variable */
            border-radius: 6px;
            font-size: 0.95em;
        }

        .automation-rule span { color: var(--subtle-text-light); } /* Use variable */
        .automation-rule .actions button {
            padding: 6px 10px;
            font-size: 0.85em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border:none;
            margin-left: 8px;
        }
        .automation-rule button.edit { background-color: var(--orange-accent); color: white; } /* Specific white */
        .automation-rule button.delete { background-color: #dc3545; color: white; } /* Specific white */
        .automation-rule button:hover { filter: brightness(110%); }

        body.dark-mode .automation-rule button.edit { color: #121212; } /* Dark text for edit button */

        /* Consumption Chart */
        #consumption-chart-section {
            background-color: var(--card-bg-light); /* Use variable */
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 20px var(--shadow-color-light); /* Use variable */
        }

        #electricityChart {
            max-height: 300px; /* Adjust as needed */
        }

        .footer {
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
            color: var(--footer-text-light); /* Use variable */
            background-color: var(--purple-gradient-start);
            margin-top: auto; /* Pushes footer to bottom if content is short */
        }

        /* Responsive Design */
        
        
        @media (max-width: 720px) {
            
            .right-panel {
                margin-top: 30px;
            }
            .sidebar {
                width: 60px;
            }
            .sidebar .nav-icon { font-size: 1.5em; }
            .top-header h1 { font-size: 1.8em; }
            .dashboard-content { padding: 0 20px 20px 20px; }
        }

        @media (max-width: 320px) {
            :root {
                font-size: 14px;
            }

            .top-header {
                flex-direction: column;
                align-items: center;
                padding: 10px;
            }

            .header-icons {
                margin-top: 10px;
            }

            .sensor-widgets-grid {
                grid-template-columns: repeat(2, minmax(110px, 1fr));
                gap: 10px;
            }

            .widget {
                padding: 12px 8px;
            }

            .widget-icon {
                width: 45px;
                height: 45px;
                font-size: 1.5em;
            }

            .sidebar {
                height: 50px;
                padding: 0 5px;
            }

            .automation-form div {
                gap: 5px;
            }

            #consumption-chart-section {
                padding: 15px;
            }

            .device-control {
                flex-direction: column;
                gap: 8px;
                padding: 10px;
            }

            .footer p {
                line-height: 1.4;
            }

            .device-label, .widget-label {
                font-size: 0.85em;
                word-break: break-word;
            }
            
            .switch {
                width: 50px;
                height: 25px;
            }
            
            .slider:before {
                width: 20px;
                height: 20px;
            }
            
            input:checked + .slider:before {
                transform: translateX(22px);
            }
            
            .charge-banner {
                padding: 10px 8px;
                font-size: 0.9em;
            }
            
            .automation-form button {
                padding: 8px 12px;
            }
        }
        
    </style>
</head>
<body>
    <!--Comentando la barra lateral original ya que no se usa en la versión final del PDF,
        pero se mantiene aquí por si se quiere reactivar o modificar.
    <div class="sidebar">
        <div class="nav-icon" title="Home"><i class="fas fa-home"></i></div>
        <div class="nav-icon" title="Search"><i class="fas fa-search"></i></div>
        <div class="nav-icon" title="Devices"><i class="fas fa-robot"></i></div>
        <div class="nav-icon" title="Settings"><i class="fas fa-cog"></i></div>
    </div>
    -->

    <div class="main-wrapper">
        <header class="top-header">
            
            <a href="https://echohome.pages.dev" target="_blank" style="text-decoration: none;" title="EchoHome Project">
                <h1>Smart EchoHome</h1>
                <!--<i class="fas fa-external-link-alt" style="color: var(--purple-dark);"></i>-->
            </a>
            <div class="header-icons">
                <button id="darkModeToggle" title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <!--<i class="fas fa-sync-alt" title="Refresh Data" onclick="updateDashboardData()"></i>-->
                <!--<i class="fas fa-user-circle" title="User Profile"></i>-->
            </div>
        </header>

        <main class="dashboard-content">
            <section class="welcome-panel">
                <h2>Hola, bienvenid@ a casa!</h2>
                <p>La calidad del aire es buena y fresca. Disfruta tu día!</p>
                <div class="weather-info">
                    <span><i class="fas fa-thermometer-half"></i> <span id="tempExt">+25</span>°C Exterior</span>
                    <span><i class="fas fa-cloud-sun"></i> Nublado difuso</span>
                </div>
            </section>

            <div class="content-grid">
                <div class="main-column">
                    <section id="system-status-section">
                        <h2 class="section-title">Estado del Sistema</h2>
                        <div id="charge_banner_container">
                            <div id="charge_banner" class="charge-banner">
                                <span id="charge_status_value">Cargando datos...</span>
                            </div>
                        </div>
                    </section>

                    <section id="sensors-section">
                        <h2 class="section-title">Sensores Ambientales e Internos</h2>
                        <div class="sensor-widgets-grid">
                            <div class="widget temperature-widget">
                                <div class="widget-icon temp"><i class="fas fa-thermometer-half"></i></div>
                                <div class="widget-label">{{ sensor_names.Temperature | default('Temperatura') }}</div>
                                <div class="widget-value" id="temp_value">-- °C</div>
                            </div>
                            <div class="widget">
                                <div class="widget-icon humidity"><i class="fas fa-tint"></i></div>
                                <div class="widget-label">{{ sensor_names.Humidity | default('Humedad') }}</div>
                                <div class="widget-value" id="humidity_value">-- %</div>
                            </div>
                            <div class="widget">
                                <div class="widget-icon voltage"><i class="fa-solid fa-car-battery"></i></div>
                                <div class="widget-label">{{ sensor_names.Voltage | default('Voltaje') }}</div>
                                <div class="widget-value" id="voltage_value">-- V</div>
                            </div>
                            <div class="widget">
                                <div class="widget-icon capacity"><i class="fas fa-battery-half"></i></div>
                                <div class="widget-label">{{ sensor_names.Capacity | default('Capacidad') }}</div>
                                <div class="widget-value" id="capacity_value">-- %</div>
                            </div>
                            <div class="widget">
                                <div class="widget-icon generate"><i id="solarMoon" class="fa-solid fa-sun"></i></div>
                                <div class="widget-label">Generando</div>
                                <div class="widget-value" id="generate_value">?W</div>
                            </div>
                            <div class="widget">
                                <div class="widget-icon power"><i class="fas fa-plug"></i></div>
                                <div class="widget-label">{{ sensor_names.Power | default('Potencia') }}</div>
                                <div class="widget-value" id="power_value">-- W</div>
                            </div>
                                
                            <div class="widget energy"> <!-- AÑADIR CLASE "energy" -->
                                <div class="widget-icon energy"><i class="fa-solid fa-bolt"></i></div>
                                <div class="widget-label">Energía Actual</div>
                                <div class="widget-value" id="energy_value">-- Wh</div>
                            </div>

                            <div class="widget">
                                <div class="widget-icon energy"><i class="fa-regular fa-sun"></i></div>
                                <div class="widget-label">Esperado</div>
                                <div class="widget-value" id="esperado_value">? Wh</div>
                            </div>
                            <div class="widget">
                                <div class="widget-icon hours"><i class="far fa-clock"></i></div>
                                <div class="widget-label">{{ sensor_names.Hours | default('Horas Uso') }}</div>
                                <div class="widget-value" id="hours_value">-- h</div>
                            </div>
                            <div class="widget">
                                <div class="widget-icon source"><i class="fas fa-solar-panel"></i></div>
                                <div class="widget-label">{{ sensor_names.Source | default('Fuente') }}</div>
                                <div class="widget-value" id="source_value">--</div>
                            </div>
                        </div>
                    </section>

                    <!-- ========= NUEVA SECCIÓN PARA EL GRÁFICO DE HOY ========= -->
                    <section id="today-consumption-section" class="device-group">
                        <h2 class="section-title">Consumo de Hoy (Acumulado en tiempo real)</h2>
                        <canvas id="todayConsumptionChart" style="max-height: 250px;"></canvas>
                    </section>
                    <!-- ======================================================= -->

                    <section id="devices-section" class="device-group">
                        <h2 class="section-title">Control de Dispositivos</h2>
                        <h3>Luces</h3>
                        {% for i in range(1,5) %}
                        <div class="device-control">
                            <div class="device-info">
                                <div class="device-icon light"><i class="fas fa-lightbulb"></i></div>
                                <div>
                                    <span class="device-label">{{ device_names[i] | default('Luz ' + i|string) }}</span>
                                    <div class="status-container">
                                        <div id="status_ch{{i}}" class="status">Obteniendo estado...</div>
                                        <div id="OnAuto{{i}}" class="status auto-status"></div>
                                        <div id="OffAuto{{i}}" class="status auto-status"></div>
                                    </div>
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="switch_ch{{i}}" onchange="handleDeviceToggle({{i}}, this, '{{ device_names[i] | default('Luz ' + i|string) }}')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        {% endfor %}

                        <h3>Puntos de Energía</h3>
                        {% for i in range(5, 7)%}
                        <div class="device-control">
                            <div class="device-info">
                                <div class="device-icon power-outlet"><i class="fas fa-power-off"></i></div>
                                <div>
                                    <span class="device-label">{{ device_names[i] | default('Energía ' + (i-4)|string) }}</span>
                                    <div class="status-container">
                                        <div id="status_ch{{i}}" class="status">Obteniendo estado...</div>
                                        <div id="OnAuto{{i}}" class="status auto-status"></div>
                                        <div id="OffAuto{{i}}" class="status auto-status"></div>
                                    </div>
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="switch_ch{{i}}" onchange="handleDeviceToggle({{i}}, this, '{{ device_names[i] | default('Energía ' + (i-4)|string) }}')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        {% endfor %}
                    </section>

                    <section id="automation-section" class="device-group">
                        <h2 class="section-title">Automatización</h2>
                        <form id="automation-form" class="automation-form">
                            <div>
                                <label for="rule-channel">Canal:</label>
                                <select id="rule-channel" required>
                                    {% for i in range(1, 7) %}
                                    <option value="{{i}}">{{device_names[i] | default('Dispositivo ' + i|string) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="rule-time-on">ON:</label>
                                <input type="time" id="rule-time-on">
                            </div>
                            <div>
                                <label for="rule-time-off">OFF:</label>
                                <input type="time" id="rule-time-off">
                            </div>
                            <div class="button-group">
                                <button type="submit">Establecer</button>
                                <button type="button" class="clear-button" onclick="clearAutomationForm()">Limpiar</button>
                            </div>
                        </form>
                        <div id="automation-list" class="automation-list">
                        </div>
                    </section>
                </div>
                <section id="consumption-chart-section">
                    <h2 class="section-title">Histórico de Consumo</h2>
                    <canvas id="electricityChart"></canvas>
                </section>

                <!--<aside class="right-panel">
                    <section id="consumption-chart-section-placeholder"> <h2 class="section-title"></h2>
                    </section>

                    <section id="consumption-chart-section">
                        <h2 class="section-title">Histórico de Carga</h2>
                        <canvas id="electricityChart"></canvas>
                    </section>

                    <section id="automation-section" class="device-group">
                        <h2 class="section-title">Automatización</h2>
                        <form id="automation-form" class="automation-form">
                            <div>
                                <label for="rule-channel">Canal:</label>
                                <select id="rule-channel" required>
                                    {% for i in range(1, 7) %}
                                    <option value="{{i}}">{{device_names[i] | default('Dispositivo ' + i|string) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="rule-time-on">ON:</label>
                                <input type="time" id="rule-time-on">
                            </div>
                            <div>
                                <label for="rule-time-off">OFF:</label>
                                <input type="time" id="rule-time-off">
                            </div>
                            <div class="button-group">
                                <button type="submit">Establecer</button>
                                <button type="button" class="clear-button" onclick="clearAutomationForm()">Limpiar</button>
                            </div>
                        </form>
                        <div id="automation-list" class="automation-list">
                        </div>
                    </section>
                </aside>-->
            </div>
        </main>

        <footer class="footer">
            <p>Controlando ESP8266 en: <span>{{ esp_ip | default('N/A') }}</span> y <span>{{ esp2_ip | default('N/A') }}</span>.</p>
            <p>&copy; 2024–2025 Smart EchoHome. Todos los derechos reservados.</p>
        </footer>
    </div>

    <script>
        // Credenciales para autenticación básica
        const authHeader = 'Basic ' + btoa('admin:idomo');
		//Calculos solares
		
        // Elementos del DOM para sensores
        
        const chargeStatusEl = document.getElementById('charge_status_value');
        const chargeBannerEl = document.getElementById('charge_banner');
        const tempExtValueEl = document.getElementById('tempExt');
        const tempValueEl = document.getElementById('temp_value');
        const humidityValueEl = document.getElementById('humidity_value');
        const voltageValueEl = document.getElementById('voltage_value');
        const capacityValueEl = document.getElementById('capacity_value');
        const powerValueEl = document.getElementById('power_value');
        const generateValueEl = document.getElementById('generate_value');
        const solarMoonValueEl = document.getElementById('solarMoon');
        const energyValueEl = document.getElementById('energy_value');
        const totalEsperadoValueEl = document.getElementById('esperado_value');
        const hoursValueEl = document.getElementById('hours_value');
        const sourceValueEl = document.getElementById('source_value');

        // Formulario de automatización
        const automationForm = document.getElementById('automation-form');
        const automationListEl = document.getElementById('automation-list');

        let electricityChartInstance = null;
        let todayConsumptionChartInstance = null; // <--- NUEVA VARIABLE

        const chartDataPoints = 30; // Show last 30 energy readings
        let energyHistory = [];

        // DARK MODE START - JavaScript Logic
        const darkModeToggle = document.getElementById('darkModeToggle');
        const body = document.body;
        const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

        function setDarkMode(enabled) {
            if (enabled) {
                body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>'; // Sun icon for dark mode
                localStorage.setItem('darkMode', 'enabled');
            } else {
                body.classList.remove('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>'; // Moon icon for light mode
                localStorage.setItem('darkMode', 'disabled');
            }
            // Update chart colors if it exists
            /*if (electricityChartInstance) {
                const isDarkMode = body.classList.contains('dark-mode');
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const ticksColor = isDarkMode ? '#e0e0e0' : '#333';
                const titleColor = isDarkMode ? '#e0e0e0' : '#333';

                electricityChartInstance.options.scales.y.grid.color = gridColor;
                electricityChartInstance.options.scales.x.grid.color = gridColor;
                electricityChartInstance.options.scales.y.ticks.color = ticksColor;
                electricityChartInstance.options.scales.x.ticks.color = ticksColor;
                electricityChartInstance.options.scales.y.title.color = titleColor;
                electricityChartInstance.options.scales.x.title.color = titleColor;
                electricityChartInstance.options.plugins.legend.labels.color = titleColor;
                electricityChartInstance.update();
            }*/
        }

        darkModeToggle.addEventListener('click', () => {
            setDarkMode(!body.classList.contains('dark-mode'));
        });

        // Check local storage or system preference on load
        const savedMode = localStorage.getItem('darkMode');
        if (savedMode === 'enabled') {
            setDarkMode(true);
        } else if (savedMode === 'disabled') {
            setDarkMode(false);
        } else if (prefersDarkScheme.matches) { // If no saved pref, check system pref
            setDarkMode(true);
        } else {
            setDarkMode(false); // Default to light mode
        }
        // DARK MODE END - JavaScript Logic

/*
        function initElectricityChart() {
            const ctx = document.getElementById('electricityChart').getContext('2d');

            // DARK MODE - Chart Color Adjustments
            const isDarkMode = body.classList.contains('dark-mode');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const ticksColor = isDarkMode ? '#e0e0e0' : '#333'; // Match --text-dark
            const titleColor = isDarkMode ? '#e0e0e0' : '#333';

            electricityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Timestamps or count
                    datasets: [{
                        label: 'Carga (W)',
                        data: [],
                        borderColor: 'var(--orange-accent)',
                        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--orange-accent').trim() + '33', // Add alpha for area, e.g., 33 for 20% opacity
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'W', color: titleColor },
                            grid: { color: gridColor },
                            ticks: { color: ticksColor }
                        },
                        x: {
                            title: { display: true, text: 'Tiempo (actualizaciones)', color: titleColor },
                            grid: { color: gridColor },
                            ticks: { color: ticksColor }
                        }
                    },
                    animation: {
                        duration: 300 //ms
                    },
                    plugins: { // DARK MODE - Legend color
                        legend: {
                            labels: {
                                color: titleColor
                            }
                        }
                    }
                }
            });
        }

        function updateElectricityChart(newEnergyValue) {
            if (!electricityChartInstance) return;

            if (energyHistory.length >= chartDataPoints) {
                energyHistory.shift(); 
                electricityChartInstance.data.labels.shift();
            }

            energyHistory.push(parseFloat(newEnergyValue) || 0);
            electricityChartInstance.data.labels.push(energyHistory.length); 
            electricityChartInstance.data.datasets[0].data = [...energyHistory];

            const currentOrangeAccent = getComputedStyle(document.documentElement).getPropertyValue('--orange-accent').trim();
            electricityChartInstance.data.datasets[0].backgroundColor = currentOrangeAccent + '33'; 

            electricityChartInstance.update();
        }
*/
        async function updateDashboardData() {
            // Update data from /get_esp_sensors
            try {
                const response = await fetch('/get_esp_sensors', {
                    headers: { 'Authorization': authHeader } });
                const data = await response.json();

                if (!response.ok || (data && data.error)) { 
                    console.error('Error al obtener datos de ESP1:', (data && data.error) || response.status);
                    if (chargeStatusEl) chargeStatusEl.textContent = 'Error ESP1';
                    if (chargeBannerEl) chargeBannerEl.className = 'charge-banner status-error'; 
                    if (tempValueEl) tempValueEl.textContent = 'N/A';
                    if (humidityValueEl) humidityValueEl.textContent = 'N/A';
                    if (voltageValueEl) voltageValueEl.textContent = 'N/A';
                    if (capacityValueEl) capacityValueEl.textContent = 'N/A';
                } else {
                    // 1. Update Charge Banner
                    if (chargeStatusEl && chargeBannerEl) {
                        chargeStatusEl.textContent = data.Charge || 'N/A';
                        let chargeState = (data.Charge || 'N/A').toUpperCase();
                        chargeBannerEl.className = 'charge-banner'; 
                        if (chargeState === 'HIGH' || chargeState === 'HIGHEST' || chargeState === 'HIGHER')
                            chargeBannerEl.classList.add('charge-high');
                        else if (chargeState === 'MID' || chargeState === 'MID-HIGH')
                            chargeBannerEl.classList.add('charge-medium');
                        else if (chargeState === 'LOWEST!' || chargeState === 'LOWER!' || chargeState === 'LOW' || chargeState === 'OVER_CHARGE!!!')
                            chargeBannerEl.classList.add('charge-low');
                        else if (chargeState === 'SOFT_CHARGE')
                            chargeBannerEl.classList.add('charge-charging');
                    }

                    // 2. Update Sensor Widgets for ESP1
                    if (tempValueEl) tempValueEl.textContent = data.Temperature !== undefined ? `${data.Temperature}°C` : 'N/A';
                    if (humidityValueEl) humidityValueEl.textContent = data.Humidity !== undefined ? `${data.Humidity}%` : 'N/A';
                    if (voltageValueEl) voltageValueEl.textContent = data.Voltage !== undefined ? `${data.Voltage}V` : 'N/A';
                    if(capacityValueEl) capacityValueEl.textContent = data.Capacity !== undefined ? `${data.Capacity}%`: 'N/A';

                    // 3. Update Device States (CH1-CH6)
                    for (let i = 1; i <= 6; i++) {
                        const channelKey = `CH${i}`;
                        const switchElement = document.getElementById(`switch_ch${i}`);
                        const statusDiv = document.getElementById(`status_ch${i}`);
                        const currentDeviceState = data && data[channelKey] ? data[channelKey].toUpperCase() : undefined;


                        if (currentDeviceState !== undefined) { 
                            if (switchElement) {
                                // Specific logic for CH5 and CH6 based on multiple ON/OFF states
                                if (channelKey === "CH5") {
                                    switchElement.checked = (currentDeviceState === "ON_MANUAL" || currentDeviceState === "ON_AUTO");
                                } else if (channelKey === "CH6") {
                                    switchElement.checked = (currentDeviceState === "ON"); // OFF and CUT OFF will be unchecked
                                } else {
                                    // Default logic for CH1-CH4
                                    switchElement.checked = (currentDeviceState === "ON");
                                }
                            }
                            if (statusDiv) {
                                statusDiv.textContent = `Estado: ${data[channelKey]}`; // Show actual state string
                                // Class for status text (success if any ON state, info otherwise unless error)
                                if (currentDeviceState.includes("ON")) {
                                     statusDiv.className = 'status success';
                                } else if (currentDeviceState.includes("OFF")) {
                                     statusDiv.className = 'status info';
                                } else {
                                     statusDiv.className = 'status'; // Default or unknown
                                }
                            }
                        } else {
                            if (statusDiv) {
                                statusDiv.textContent = 'Estado: Desconocido';
                                statusDiv.className = 'status';
                            }
                            if (switchElement) { // Default to off if no data
                                switchElement.checked = false;
                            }
                            console.warn(`No data found for ${channelKey} in ESP1 response.`);
                        }
                    }
                }
            } catch (error) {
                console.error('Fallo al actualizar datos ESP1:', error);
                if(chargeStatusEl) chargeStatusEl.textContent = 'Error de Red ESP1';
                if(chargeBannerEl) chargeBannerEl.className = 'charge-banner status-error';
                if(tempValueEl) tempValueEl.textContent = 'N/A';
                if(humidityValueEl) humidityValueEl.textContent = 'N/A';
                if(voltageValueEl) voltageValueEl.textContent = 'N/A';
                if(capacityValueEl) capacityValueEl.textContent = 'N/A';
                for (let i = 1; i <= 6; i++) { 
                    const statusDiv = document.getElementById(`status_ch${i}`);
                    if (statusDiv) { statusDiv.textContent = 'Error de Red'; statusDiv.className = 'status error';}
                     const switchElement = document.getElementById(`switch_ch${i}`);
                    if (switchElement) { switchElement.checked = false; } // Default to off on error
                }
            }

            // Update data from /get_esp2_sensors
            try {
                const response2 = await fetch('/get_esp2_sensors', {
                    headers: { 'Authorization': authHeader } });
                const data2 = await response2.json();

                if (!response2.ok || (data2 && data2.error)) {
                    console.error('Error al obtener datos de ESP2:', (data2 && data2.error) || response2.status);
                    //if(powerValueEl) powerValueEl.textContent = 'N/A'; 
                    //if(energyValueEl) energyValueEl.textContent = 'N/A';
                    //if(hoursValueEl) hoursValueEl.textContent = 'N/A';
                    //if(sourceValueEl) sourceValueEl.textContent = 'N/A';
                } else {
                    if(powerValueEl) powerValueEl.textContent = data2.Power !== undefined ? `${data2.Power}W` : 'N/A';
                    if(energyValueEl) {
                        energyValueEl.textContent = data2.Energy !== undefined ? `${data2.Energy}Wh` : 'N/A';
                        /*if (data2.Power !== undefined)
                            updateElectricityChart(data2.Power);*/
                    }
                    if(hoursValueEl) hoursValueEl.textContent = data2.Hours !== undefined ? `${data2.Hours}h` : 'N/A';
                    if(sourceValueEl) sourceValueEl.textContent = data2.Source !== undefined ? `${data2.Source.toUpperCase()}` : 'N/A';

                    // --- NUEVA LÓGICA PARA LA TARJETA DE ENERGÍA ---
                    //const energyValueEl = document.getElementById('energy_value');
                    if (energyValueEl) {
                        let energiaMostrada = 0;
                        let etiquetaEnergia = "Energía";

                        if (data2.Source === 'solar') {
                            energiaMostrada = data2.PaSol || 0;
                        } else { // 'red'
                            energiaMostrada = data2.PaRed || 0;
                        }
                        
                        document.querySelector('.widget.energy .widget-label').textContent = etiquetaEnergia;
                        //energyValueEl.textContent = `${parseFloat(energiaMostrada).toFixed(0)} Wh`;
                     }
                }
            } catch (error) {
                console.error('Fallo al actualizar datos ESP2:', error);
                if(powerValueEl) powerValueEl.textContent = 'Error Red';
                if(energyValueEl) energyValueEl.textContent = 'Error Red';
                if(hoursValueEl) hoursValueEl.textContent = 'Error Red';
                if(sourceValueEl) sourceValueEl.textContent = 'Error Red';
            }

            updateTodayConsumptionChart();
        }

        async function sendDeviceCommand(channel, action, deviceName) {
            const statusDivId = `status_ch${channel}`;
            const statusDiv = document.getElementById(statusDivId);
            const switchElement = document.getElementById(`switch_ch${channel}`); 
            const intendedCheckedState = (action === 'on');


            if (!statusDiv) {
                console.error(`Elemento de estado ${statusDivId} no encontrado.`);
                return;
            }
            
            statusDiv.textContent = `Enviando orden a ${deviceName}...`;
            statusDiv.className = 'status info';

            try {
                const response = await fetch(`/set_device_state/${channel}/${action}`, { headers: { 'Authorization': authHeader } });
                const data = await response.json();

                if (response.ok) {
                    // statusDiv.textContent = data.message || `Comando enviado. ESP: ${data.status_code}`;
                    // The status text and class will be updated by updateDashboardData
                    setTimeout(updateDashboardData, 300); // Reduced delay
                } else {
                    statusDiv.textContent = `Error (${response.status}): ${data.error || 'Error desconocido'}`;
                    statusDiv.className = 'status error';
                    if (switchElement && switchElement.checked === intendedCheckedState) {
                        switchElement.checked = !intendedCheckedState; // Revert optimistic UI update
                    }
                    setTimeout(updateDashboardData, 100); 
                }
            } catch (error) {
                console.error(`Error en la solicitud para ${deviceName}:`, error);
                statusDiv.textContent = `Error de conexión para ${deviceName}.`;
                statusDiv.className = 'status error';
                if (switchElement && switchElement.checked === intendedCheckedState) {
                     switchElement.checked = !intendedCheckedState; // Revert optimistic UI update
                }
                setTimeout(updateDashboardData, 100); 
            }
        }

        function handleDeviceToggle(channel, checkboxElement, deviceName) {
            const action = checkboxElement.checked ? 'on' : 'off';
            sendDeviceCommand(channel, action, deviceName);
        }

        function clearAutomationForm(){
            automationForm.reset();
            document.getElementById('rule-channel').value = 1; 
            automationForm.onsubmit = saveAutomationRule; 
        }

        async function loadAutomationRules() {
            try {
                const response = await fetch('/auto', { headers: { 'Authorization': authHeader } });
                const rules = await response.json();

                if (!response.ok) {
                    automationListEl.innerHTML = `<div class="status error">Error al cargar horarios: ${rules.error || response.status}</div>`;
                    return;
                }

                if (rules.length === 0) {
                    automationListEl.innerHTML = '<div class="status info">No hay horarios de automatización configurados.</div>';
                } else {
                    automationListEl.innerHTML = '';
                    rules.forEach(rule => {
                        const ruleDiv = document.createElement('div');
                        ruleDiv.className = 'automation-rule';
                        const deviceName = document.querySelector(`#rule-channel option[value="${rule.channel}"]`)?.textContent || `Canal ${rule.channel}`;
                        const timeOnText = rule.timeOn ? `ON: ${rule.timeOn}` : 'Sin ON';
                        const timeOffText = rule.timeOff ? `OFF: ${rule.timeOff}` : 'Sin OFF';

                        ruleDiv.innerHTML = `
                            <span>${deviceName} <br> <small>${timeOnText} | ${timeOffText}</small></span>
                            <div class="actions">
                                <button class="edit" onclick="editRule(${rule.channel}, '${rule.timeOn || ""}', '${rule.timeOff || ""}')"><i class="fas fa-edit"></i> Editar</button>
                                </div>
                        `;
                        automationListEl.appendChild(ruleDiv);

                        const onAutoEl = document.getElementById(`OnAuto${rule.channel}`);
                        if(onAutoEl) onAutoEl.innerText = rule.timeOn ? `AutoON: ${rule.timeOn}` : "";
                        const offAutoEl = document.getElementById(`OffAuto${rule.channel}`);
                        if(offAutoEl) offAutoEl.innerText = rule.timeOff ? `AutoOFF: ${rule.timeOff}` : "";
                    });
                }
            } catch (error) {
                console.error('Error al cargar horarios:', error);
                automationListEl.innerHTML = '<div class="status error">Error de conexión al cargar horarios.</div>';
            }
        }

        async function saveAutomationRule(event) {
            event.preventDefault();
            const channel = document.getElementById('rule-channel').value;
            const timeOn = document.getElementById('rule-time-on').value || "";
            const timeOff = document.getElementById('rule-time-off').value || "";

            try {
                const response = await fetch('/auto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify({ channel: parseInt(channel), timeOn, timeOff })
                });
                const data = await response.json();

                if (response.ok) {
                    automationForm.reset();
                    document.getElementById('rule-channel').value = 1; 
                    automationForm.onsubmit = saveAutomationRule;
                    setTimeout(loadAutomationRules, 300);
                } else {
                    const errorMsg = `Error al guardar: ${data.error || 'Error desconocido'}`;
                    console.error(errorMsg);
                    const tempErrorDiv = document.createElement('div');
                    tempErrorDiv.className = 'status error';
                    tempErrorDiv.textContent = errorMsg;
                    automationListEl.insertBefore(tempErrorDiv, automationListEl.firstChild);
                    setTimeout(() => tempErrorDiv.remove(), 5000); 
                }
            } catch (error) {
                const errorMsg = 'Error de conexión al guardar horario.';
                console.error('Error al guardar horario:', error);
                const tempErrorDiv = document.createElement('div');
                tempErrorDiv.className = 'status error';
                tempErrorDiv.textContent = errorMsg;
                automationListEl.insertBefore(tempErrorDiv, automationListEl.firstChild);
                setTimeout(() => tempErrorDiv.remove(), 5000);
            }
        }

        function editRule(channel, timeOn, timeOff) {
            document.getElementById('rule-channel').value = channel;
            document.getElementById('rule-time-on').value = timeOn || "";
            document.getElementById('rule-time-off').value = timeOff || "";
            automationForm.scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteRule(channel) {
            if (!window.confirm(`¿Seguro que quieres eliminar la automatización para el canal ${channel}?`)) return;

            try {
                const response = await fetch(`/auto/${channel}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': authHeader }
                });
                const data = await response.json();

                if (response.ok) {
                    setTimeout(loadAutomationRules, 300);
                } else {
                    const errorMsg = `Error al eliminar: ${data.error || 'Error desconocido'}`;
                    console.error(errorMsg);
                    const tempErrorDiv = document.createElement('div');
                    tempErrorDiv.className = 'status error';
                    tempErrorDiv.textContent = errorMsg;
                    automationListEl.insertBefore(tempErrorDiv, automationListEl.firstChild);
                    setTimeout(() => tempErrorDiv.remove(), 5000);
                }
            } catch (error) {
                const errorMsg = 'Error de conexión al eliminar horario.';
                console.error('Error al eliminar horario:', error);
                const tempErrorDiv = document.createElement('div');
                tempErrorDiv.className = 'status error';
                tempErrorDiv.textContent = errorMsg;
                automationListEl.insertBefore(tempErrorDiv, automationListEl.firstChild);
                setTimeout(() => tempErrorDiv.remove(), 5000);
            }
        }

        // Función para obtener el valor de hora generada y tempExt desde el backend
        async function obtenerDatos() {
            try {
                const response = await fetch('/datosClima');
                
                // Verificar si la respuesta es exitosa
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }

                // Obtener el valor de la respuesta
                const data = await response.json();
                
                // Acceder a los valores
                const valorHoraGenerada = data.horaGenerada;
                const temperaturaExterior = data.tempExt;
                const sumatoriaHoraGenerada = data.sumatoria;
                const horaAct = data.horaActual;
                
                if (horaAct < 6 || horaAct > 18){
                    solarMoonValueEl.classList.remove('fa-sun');
                    solarMoonValueEl.classList.add('fa-moon');

                } else {
                    solarMoonValueEl.classList.remove('fa-moon');
                    solarMoonValueEl.classList.add('fa-sun');
                }

                // Mostrar los valores en la consola o usarlos como necesites
                //console.log(`Valor correspondiente a la hora actual: ${valorHoraGenerada}`);
                //console.log(`Temperatura exterior: ${temperaturaExterior}`);
                generateValueEl.textContent = valorHoraGenerada + "W";
                tempExtValueEl.textContent = temperaturaExterior;
                totalEsperadoValueEl.textContent = sumatoriaHoraGenerada + "Wh";

            } catch (error) {
                console.error('Error al obtener los datos:', error);
            }
        }

        // Llamar a la función para obtener los valores
        obtenerDatos();

        // En el DOMContentLoaded
        /*function adjustViewport() {
        const viewportWidth = Math.max(document.documentElement.clientWidth || 0);
        if (viewportWidth < 360) {
            document.querySelector('meta[name="viewport"]')
            .setAttribute('content', 'width=360, user-scalable=yes');
        }
        }*/
        //adjustViewport();
        //window.addEventListener('resize', adjustViewport);

        async function loadAndDisplayHistory() {
    try {
        const response = await fetch('/api/history');
        const historyData = await response.json();
        
        if (historyData.error) {
            console.error(historyData.error);
            return;
        }

        // historyData es un array de objetos: [{date, solar_wh, grid_wh}, ...]
        // Ordena los datos por fecha para el gráfico
        historyData.sort((a, b) => new Date(a.date) - new Date(b.date));

        const labels = historyData.map(d => d.date);
        const solarData = historyData.map(d => d.solar_wh);
        const gridData = historyData.map(d => d.grid_wh);

        // Aquí puedes usar Chart.js para crear un gráfico de barras
        // Reemplaza el gráfico de línea existente con uno de barras
        const ctx = document.getElementById('electricityChart').getContext('2d');
        if(window.myHistoryChart) {
            window.myHistoryChart.destroy(); // Destruye el gráfico anterior si existe
        }
        window.myHistoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Consumo Solar (Wh)',
                        data: solarData,
                        backgroundColor: 'rgba(255, 206, 86, 0.7)', // Amarillo
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Consumo Red (Wh)',
                        data: gridData,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)', // Rojo
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Consumo (Wh)' }
                    },
                    x: {
                        title: { display: true, text: 'Fecha' }
                    }
                }
            }
        });

    } catch (error) {
        console.error("Error al cargar el historial de consumo:", error);
    }
}

        function initTodayConsumptionChart() {
    const ctx = document.getElementById('todayConsumptionChart').getContext('2d');
    
    todayConsumptionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Solar', 'Red'], // Solo dos categorías
            datasets: [{
                label: 'Consumo del Día (Wh)',
                data: [0, 0], // Empezamos con 0
                backgroundColor: [
                    'rgba(255, 206, 86, 0.7)', // Amarillo para Solar
                    'rgba(255, 99, 132, 0.7)'  // Rojo para Red
                ],
                borderColor: [
                    'rgba(255, 206, 86, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Energía Acumulada (Wh)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false // Opcional: la leyenda es redundante con solo 2 barras
                }
            }
        }
    });
}

        async function updateTodayConsumptionChart() {
    if (!todayConsumptionChartInstance) return; // No hacer nada si el gráfico no está listo

    try {
        const response = await fetch('/api/today_consumption');
        const data = await response.json();

        if (data.error) {
            console.error("Error al obtener consumo de hoy:", data.error);
            return;
        }

        // Actualizamos los datos del gráfico con los nuevos valores
        todayConsumptionChartInstance.data.datasets[0].data[0] = data.solar_wh;
        todayConsumptionChartInstance.data.datasets[0].data[1] = data.grid_wh;

        // Le decimos a Chart.js que se redibuje con los datos nuevos
        todayConsumptionChartInstance.update();

    } catch (error) {
        console.error("Fallo de conexión al actualizar consumo de hoy:", error);
    }
}

        document.addEventListener('DOMContentLoaded', () => {
            //initElectricityChart();
            loadAndDisplayHistory();  // Carga el historial de días pasados
            initTodayConsumptionChart(); // <--- INICIALIZA EL NUEVO GRÁFICO

            updateDashboardData(); 
            loadAutomationRules();

            setInterval(updateDashboardData, 6000); 
            setInterval(loadAutomationRules, 3000);
            setInterval(obtenerDatos, 30000);
            //setInterval(updateTodayConsumptionChart, 15000);
            automationForm.reset();
            document.getElementById('rule-channel').value = 1; 
            automationForm.addEventListener('submit', saveAutomationRule);
            //window.addEventListener('resize', adjustViewport);
            //loadAndDisplayHistory(); // Llama a la función al cargar la página
        });
    </script>
</body>
</html>
